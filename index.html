<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FGN Builder</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="includes/css/styles.min.css" rel="stylesheet">
    <style>
        /* Employee Spotlight accordion styles - not in compiled CSS */
        .employee-spotlight-section.article-group {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .employee-spotlight-section.article-group:hover {
            border-color: #0c2a4a;
        }
        .employee-spotlight-section.article-group.collapsed .article-content {
            display: none;
        }
        .employee-spotlight-section.article-group .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 2px solid #e0e0e0;
            user-select: none;
            background: white;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .employee-spotlight-section.article-group .article-header:hover {
            background: #f5f5f5;
        }
        .employee-spotlight-section.article-group .article-header .article-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .employee-spotlight-section.article-group .article-header .article-header-left .article-toggle {
            font-size: 18px;
            color: #0c2a4a;
            transition: transform 0.3s ease;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        .employee-spotlight-section.article-group .article-header .article-header-left .article-number {
            font-weight: 700;
            color: #0c2a4a;
            font-size: 18px;
        }
        .employee-spotlight-section.article-group .article-content {
            padding: 10px;
            transition: all 0.3s ease;
        }
        
        /* Tooltip styles */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
            margin-left: 6px;
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0c2a4a;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            vertical-align: middle;
        }
        .tooltip-icon:hover {
            background: #e5253a;
        }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            width: 280px;
            max-width: calc(100vw - 40px);
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px 12px;
            position: absolute;
            z-index: 1000;
            bottom: calc(100% + 8px);
            left: 0;
            transform: translateX(0);
            font-size: 13px;
            line-height: 1.4;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            word-wrap: break-word;
            white-space: normal;
        }
        /* On smaller screens, position tooltip to the right */
        @media (max-width: 600px) {
            .tooltip-text {
                left: auto;
                right: 0;
                transform: none;
            }
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 20px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        @media (max-width: 600px) {
            .tooltip-text::after {
                left: auto;
                right: 20px;
            }
        }
        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FGN Builder</h1>
        </div>

        <div class="main-content-wrapper">
            <div class="form-section">
                <div class="date-picker-section">
                    <div class="form-group">
                        <label class="required">Publication Date</label>
                        <input type="date" id="publicationDate" onchange="updatePublicationDate(this.value)" />
                        <div id="dateRequiredMessage" style="margin-top: 8px; padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404; font-size: 14px; display: block;">
                            ⚠️ Please set a publication date before adding articles or filling out content.
                        </div>
                    </div>
                </div>

                <div class="articles-container" id="articlesContainer">
                    <!-- Articles will be dynamically added here -->
                </div>

                <div class="form-actions">
                    <button type="button" class="add-article-btn" onclick="addArticle()">
                        + Add Article
                    </button>
                    <button type="button" class="add-article-btn" onclick="addThankDonor()" id="addThankDonorBtn">
                        + Add Thank the Donor
                    </button>
                    <button type="button" class="copy-btn" onclick="copyToClipboard()">
                        Copy Code
                    </button>
                    <button type="button" class="copy-btn" onclick="showImportModal()" style="background: #0c2a4a;">
                        Import HTML
                    </button>
                </div>

                <!-- Import Modal -->
                <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;" onclick="if(event.target.id === 'importModal') closeImportModal();">
                    <div style="max-width: 800px; margin: 50px auto; background: white; padding: 24px; border-radius: 8px; position: relative;" onclick="event.stopPropagation();">
                        <h2 style="margin-top: 0;">Import HTML</h2>
                        <p style="color: #666; margin-bottom: 16px;">Paste the HTML output from this system to import existing content:</p>
                        <textarea id="importHtmlTextarea" style="width: 100%; height: 300px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;" placeholder="Paste HTML here..."></textarea>
                        <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="importHtml()" style="background: #0c2a4a; color: white;">Import</button>
                        </div>
                    </div>
                </div>

                <div class="employee-spotlight-section article-group" id="employeeSpotlightGroup">
                    <div class="article-header" onclick="toggleEmployeeSpotlight()">
                        <div class="article-header-left">
                            <span class="article-toggle">▼</span>
                            <span class="article-number">Employee Spotlight</span>
                        </div>
                        <div class="article-actions" onclick="event.stopPropagation()">
                        </div>
                    </div>
                    <div class="article-content">
                    <div class="form-group">
                        <label class="required">Name</label>
                        <input type="text" id="employeeSpotlightName" value="First Last" oninput="updateEmployeeSpotlight('name', this.value)" placeholder="Enter employee name" />
                    </div>
                    <div class="form-group">
                        <label class="required">Title</label>
                        <input type="text" id="employeeSpotlightTitle" value="Job Title" oninput="updateEmployeeSpotlight('title', this.value)" placeholder="Enter employee title" />
                    </div>
                    <div class="form-group">
                        <label class="required">Image URL</label>
                            <input type="text" id="employeeSpotlightImageUrl" value="https://www.bloodcenter.org/webres/Image/placeholder.jpg" oninput="updateEmployeeSpotlight('imageUrl', this.value)" placeholder="Enter filename only (e.g., image.jpg)" />
                    </div>
                    <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label style="margin: 0;">Questions & Answers</label>
                                <button type="button" class="btn btn-secondary btn-small" onclick="addEmployeeSpotlightQuestion()">+ Add Question</button>
                    </div>
                            <div id="employeeSpotlightQuestions">
                                <!-- Questions will be dynamically added here -->
                </div>
                </div>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <div class="preview-container">
                    <iframe id="previewFrame" class="preview-frame"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let articles = [];
        let articleCounter = 0;
        let templateContent = '';
        let draggedElement = null;
        let quillEditors = {}; // Store Quill editor instances
        let updateTimeout = null; // Debounce timer for real-time updates
        let publicationDate = ''; // Store the selected publication date
        let publicationDateISO = ''; // Store the ISO format date (YYYY-MM-DD) for schema
        let employeeSpotlight = {
            name: 'First Last',
            title: 'Job Title',
            imageUrl: 'https://www.bloodcenter.org/webres/Image/placeholder.jpg',
            questions: [] // Array of {question: '', answer: ''} objects
        };
        let thankTheDonor = {
            enabled: false,
            collapsed: false,
            id: 'thank-donor-section',
            title: '',
            body: '',
            imageUrl: '',
            imageAlt: ''
        };
        let thankDonorQuill = null; // Store Quill editor for thank the donor content
        let employeeSpotlightCollapsed = false; // Track Employee Spotlight collapsed state

                                                                                                                                // Initialize template content (embedded to avoid CORS issues with file://)
        function initializeTemplate() {
            // Template content from output.html - embedded directly to avoid CORS issues
            const templateString = "<meta charset=\"utf-8\" /><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n<title></title>\n<meta name=\"description\" content=\"Stay updated with the latest feel-good news from ImpactLife. Read inspiring stories about blood donation, community impact, and life-saving moments.\" /><meta property=\"og:title\" content=\"Feel-Good News - ImpactLife\" /><meta property=\"og:description\" content=\"Stay updated with the latest feel-good news from ImpactLife. Read inspiring stories about blood donation, community impact, and life-saving moments.\" /><meta property=\"og:site_name\" content=\"ImpactLife\" /><meta property=\"og:type\" content=\"article\" /><meta name=\"twitter:card\" content=\"summary_large_image\" /><meta name=\"twitter:title\" content=\"Feel-Good News - ImpactLife\" /><meta name=\"twitter:description\" content=\"Stay updated with the latest feel-good news from ImpactLife. Read inspiring stories about blood donation, community impact, and life-saving moments.\" />\n<style type=\"text/css\">/* Enhanced Feel-Good News Layout */\n    :root{\n      --navy:#0c2a4a;\n      --red:#e5253a;\n      --yellow:#f4b000;\n      --gray-100:#f6f7f9;\n      --radius:18px;\n      --gap:24px;\n    }\n    *{box-sizing:border-box}\n    body{background:var(--gray-100);}\n\n    .wrapper{max-width:1120px;margin-inline:auto;padding:28px 18px 56px;}\n\n    /* Hero Section */\n    header.hero{\n      background:var(--navy);\n      color:#fff;\n      border-radius:var(--radius);\n      padding:36px 24px 52px;\n      position:relative;\n      overflow:hidden;\n    }\n    .brand-row{display:flex;align-items:center;gap:12px;margin-bottom:8px}\n    .brand img{height:28px;width:auto}\n    .hero h1{margin:8px 0 10px; font-family: 'Roboto Condensed', Helvetica, sans-serif; font-weight:700; text-transform:uppercase; font-size:5rem;}\n    h1:before{display:none;}\n    .date-badge{\n      position:absolute;right:18px;top:18px;\n      background:var(--red);color:#fff;\n      padding:10px 14px;border-radius:999px;\n      font-weight:700;font-size:14px\n    }\n    .hero-stripe{position:absolute;left:0;bottom:0;width:100%;height:30px;display:flex;flex-direction:column;}\n    .hero-stripe div{width:100%;height:10px;}\n    .hero-stripe-top{background:#c20f2e;}\n    .hero-stripe-middle{background:#ef7b25;}\n    .hero-stripe-bottom{background:#f4b222;}\n    .spotlight-stripe{position:absolute;left:0;bottom:0;width:100%;height:30px;display:flex;flex-direction:column;}\n    .spotlight-stripe div{width:100%;height:10px;}\n    .spotlight-stripe-top{background:#c20f2e;}\n    .spotlight-stripe-middle{background:#ef7b25;}\n    .spotlight-stripe-bottom{background:#f4b222;}\n\n    /* Main Content Grid - Masonry Style */\n    .main-grid{column-count:2;column-gap:var(--gap);margin-top:var(--gap);}\n    .main-content{column-break-inside:avoid;break-inside:avoid;}\n    .sidebar{grid-column:2;}\n    \n    /* Masonry Flow Classes */\n    .masonry-item{break-inside:avoid;margin-bottom:var(--gap);display:inline-block;width:100%;}\n    .masonry-item:last-child{margin-bottom:0;}\n    \n    /* Article Cards */\n    .card{\n      background:#fff;border-radius:var(--radius);\n      padding:22px 20px;box-shadow:0 2px 10px rgba(12,42,74,.06);\n      margin-bottom:var(--gap);\n      transition: all 0.3s ease;\n      cursor: pointer;\n    }\n    .card:hover{\n      transform: translateY(-4px);\n      box-shadow:0 8px 25px rgba(12,42,74,.15);\n      background:var(--navy);\n      color:#fff;\n    }\n    .card h2{font-family: 'Roboto Condensed', Helvetica, sans-serif; font-weight:700; text-transform:uppercase; color:var(--navy); margin-bottom:12px;}\n    .card:hover h2{color:#fff;}\n    .card blockquote{font-family: 'Roboto Condensed', Helvetica, sans-serif; font-weight:700; font-style:italic; color:var(--red); border-left:4px solid var(--red); padding-left:16px; margin:16px 0;}\n    .card:hover blockquote{color:#fff; border-left-color:#fff;}\n    \n    /* Links */\n    a{color:var(--red); text-decoration:none;}\n    a:hover{text-decoration:underline;}\n    .card:hover a{color:#fff;}\n    \n    /* Button Styling */\n    .btn{font-size:inherit; padding:.625em 1.5em;}\n    \n    /* Media Grid */\n    .media{display:grid;gap:12px;grid-template-columns:1fr 1fr;margin-top:14px}\n    .media img{width:100%;height:auto;border-radius:14px;display:block}\n    .media.single{grid-template-columns:1fr}\n    .masonry-image{width:100%; height:auto; display:block; max-width:500px; opacity:1; transition: opacity 1s ease-in-out;}\n    \n    /* Video Container */\n    .video-container{\n      position:relative;\n      width:100%;\n      height:0;\n      padding-bottom:56.25%; /* 16:9 aspect ratio */\n      overflow:hidden;\n      border-radius:14px;\n    }\n    .video-container iframe{\n      position:absolute;\n      top:0;\n      left:0;\n      width:100%;\n      height:100%;\n    }\n    \n    /* Sidebar */\n    .sidebar{display:none;}\n    \n    /* Bottom Spotlight Section */\n    .bottom-spotlight{\n      grid-column:1 / -1;\n      margin-top:var(--gap);\n      min-height:fit-content;\n    }\n    \n    /* Thank The Donor Section */\n    .thank-donor-section{\n      grid-column:1;\n      margin-top:var(--gap);\n      min-height:fit-content;\n      background:var(--yellow);\n      color:var(--navy);\n      transition: all 0.3s ease;\n      cursor: pointer;\n    }\n    .thank-donor-section:hover{\n      transform: translateY(-4px);\n      box-shadow:0 8px 25px rgba(244,176,0,.3);\n      background:#e6a600;\n    }\n    .thank-donor-section h2{\n      color:var(--navy);\n    }\n    \n    /* Callout Sections */\n    .callout{\n      background:var(--navy);color:#fff;border-radius:var(--radius);\n      padding:22px 20px;\n      transition: all 0.3s ease;\n      cursor: pointer;\n      position:relative;\n      overflow:hidden;\n    }\n    .callout.bottom-spotlight{\n      padding-bottom:52px;\n    }\n    .callout:hover{\n      transform: translateY(-4px);\n      box-shadow:0 8px 25px rgba(12,42,74,.3);\n      background:#0a1f3a;\n    }\n    .callout h2{color:#fff; font-family: 'Roboto Condensed', Helvetica, sans-serif; font-weight:700; text-transform:uppercase;}\n    .spotlight-grid{display:grid;gap:14px;grid-template-columns:1fr 1.15fr;align-items:start;}\n    .spotlight-photo{width:100%;height:auto;max-height:500px;border-radius:16px;display:block;object-fit:cover;}\n    .pill{display:inline-block;background:var(--red);color:#fff;font-weight:800;\n      padding:6px 12px;border-radius:999px;margin-bottom:10px;}\n\n    /* Special Sections */\n    .highlight-box{\n      background:linear-gradient(135deg, var(--red) 0%, #BB2031 100%);\n      color:#fff;\n      border-radius:var(--radius);\n      padding:20px;\n      margin:var(--gap) 0;\n    }\n    .highlight-box h3{color:#fff; margin-bottom:12px; font-family: 'Roboto Condensed', Helvetica, sans-serif; font-weight:700; text-transform:uppercase;}\n    \n    /* Footer */\n    footer{margin-top:var(--gap);background:#001a33;color:#dbe6f2;border-radius:var(--radius);}\n    footer .inner{padding:16px 20px;text-align:center;font-size:14px}\n\n    /* Side-by-Side Container */\n    .side-by-side-container{\n      display:grid;\n      grid-template-columns:1fr 1fr;\n      gap:var(--gap);\n      margin-top:var(--gap);\n      grid-column:1 / -1;\n    }\n    .side-by-side-container .thank-donor-section,\n    .side-by-side-container .bottom-spotlight{\n      margin:0;\n    }\n    \n    /* Responsive Design */\n    @media (max-width:980px){\n      .main-grid{column-count:1;}\n      .main-content{grid-column:1; order:1; display:contents;}\n      .sidebar{grid-column:1; order:2; display:contents;}\n      .thank-donor-section{grid-column:1; order:3;}\n      .bottom-spotlight{grid-column:1; order:4;}\n      .side-by-side-container{grid-template-columns:1fr;}\n      .spotlight-grid{grid-template-columns:1fr}\n      .media{grid-template-columns:1fr}\n      .date-badge{position:static;display:inline-block;margin-top:8px}\n    }\n    \n    @media (max-width:768px){\n      .wrapper{padding:18px 12px 36px;}\n      .hero{padding:24px 18px 52px;}\n      .card{padding:18px 16px;}\n      .callout{padding:18px 16px;}\n      .callout.bottom-spotlight{padding-bottom:52px;}\n    }\n</style>\n<div class=\"wrapper\"><!-- HERO -->\n<header aria-labelledby=\"title\" class=\"hero\">\n<div class=\"date-badge\">$FORMVALUE_PUBLICATION_DATE</div>\n\n<h1 id=\"title\" style=\"color:white;\">FEEL-GOOD NEWS</h1>\n\n<div class=\"hero-stripe\">\n<div class=\"hero-stripe-top\"></div>\n<div class=\"hero-stripe-middle\"></div>\n<div class=\"hero-stripe-bottom\"></div>\n</div>\n</header>\n\n\n<!-- Main Content - Masonry Layout -->\n<div class=\"main-grid\">\n  <div class=\"main-content\">\n  \n    <!-- Left Column -->\n\n    <!-- Story 1 -->\n    <article class=\"card masonry-item\" style=\"order: 1;\">\n      <h2>$FORMVALUE_TITLE_01</h2>\n      <p>$FORMVALUE_BODY_CONTENT_01</p>\n      <div class=\"media single\">\n        <img class=\"masonry-image\" alt=\"$FORMVALUE_IMAGE_ALT_01\" id=\"$FORMVALUE_IMAGE_ID_01\" src=\"$FORMVALUE_IMAGE_URL_01\" />\n      </div>\n    </article>\n\n    <!-- Story 3 -->\n    <article class=\"card masonry-item\" style=\"order: 3;\">\n      <h2>$FORMVALUE_TITLE_03</h2>\n      <p>$FORMVALUE_BODY_CONTENT_03</p>\n      <div class=\"media single\">\n        <img class=\"masonry-image\" alt=\"$FORMVALUE_IMAGE_ALT_03\" id=\"$FORMVALUE_IMAGE_ID_03\" src=\"$FORMVALUE_IMAGE_URL_03\" />\n      </div>\n    </article>\n  </div>\n\n\n  <!-- Right Column -->\n\n  <div class=\"sidebar\">\n  \n    <!-- Story 2 -->\n    <article class=\"card masonry-item\" style=\"order: 2;\">\n      <h2>$FORMVALUE_TITLE_02</h2>\n      <p>$FORMVALUE_BODY_CONTENT_02</p>\n      <div class=\"media single\">\n        <img class=\"masonry-image\" alt=\"$FORMVALUE_IMAGE_ALT_02\" id=\"$FORMVALUE_IMAGE_ID_02\" src=\"$FORMVALUE_IMAGE_URL_02\" />\n      </div>\n    </article>\n\n    <!-- Story 4 -->\n    <article class=\"card masonry-item\" style=\"order: 4;\">\n      <h2>$FORMVALUE_TITLE_04</h2>\n      <p>$FORMVALUE_BODY_CONTENT_04</p>\n      <div class=\"media single\">\n        <img class=\"masonry-image\" alt=\"$FORMVALUE_IMAGE_ALT_04\" id=\"$FORMVALUE_IMAGE_ID_04\" src=\"$FORMVALUE_IMAGE_URL_04\" />\n        <div class=\"video-container\">\n          <iframe allowfullscreen=\"\" frameborder=\"0\" mozallowfullscreen=\"\" src=\"$FORMVALUE_VIDEO_URL_04\" webkitallowfullscreen=\"\"></iframe>\n        </div>\n      </div>\n    </article>\n\n  </div>\n\n</div>\n<!-- Employee Spotlight -->\n\n<section class=\"callout bottom-spotlight\" style=\"order: 5;\"><span class=\"pill\">EMPLOYEE SPOTLIGHT</span>\n\n<h2 style=\"text-align: center;\">$EMPLOYEE_SPOTLIGHT_NAME</h2>\n<p style=\"text-align: center; margin-top: 8px; margin-bottom: 16px; font-size: 1.1em;\">$EMPLOYEE_SPOTLIGHT_TITLE</p>\n\n<div class=\"spotlight-grid\">\n<div><img alt=\"$EMPLOYEE_SPOTLIGHT_NAME, $EMPLOYEE_SPOTLIGHT_TITLE\" class=\"spotlight-photo\" src=\"$EMPLOYEE_SPOTLIGHT_URL\" /></div>\n\n<div>\n<p>$EMPLOYEE_SPOTLIGHT_CONTENT</p>\n</div>\n</div>\n\n<div class=\"spotlight-stripe\">\n<div class=\"spotlight-stripe-top\"></div>\n<div class=\"spotlight-stripe-middle\"></div>\n<div class=\"spotlight-stripe-bottom\"></div>\n</div>\n</section>\n</div>\n<!-- Footer -->\n\n<footer>\n<div class=\"inner\">\n<p>Feel-Good News is published every Friday to inspire + connect our ImpactLife team.</p>\n</div>\n</footer>\n</div>\n<script>\n  (function () {\n    // Form Gallery\n    const formImages = [\n      \"$FORMVALUE_IMAGE_GALLERY_URL_01\",\n      \"$FORMVALUE_IMAGE_GALLERY_URL_02\",\n      \"$FORMVALUE_IMAGE_GALLERY_URL_03\",\n      \"$FORMVALUE_IMAGE_GALLERY_URL_04\",\n      \"$FORMVALUE_IMAGE_GALLERY_URL_05\"\n    ];\n    let formIndex = 0;\n    const adamImg = document.getElementById(\"$FORMVALUE_IMAGE_GALLERY_ID_01\");\n    \n    if (formImg) {\n      setInterval(function () {\n        // fade out\n        formImg.style.opacity = 0;\n        \n        setTimeout(() => {\n          // change image once faded\n          formIndex = (formIndex + 1) % formImages.length;\n          formImg.src = formImages[formIndex];\n          // fade in\n          formImg.style.opacity = 1;\n        }, 1000); // matches transition duration\n      }, 5000); // switch every 5 seconds\n    }\n  })();\n" + '</' + 'script>' + "<script>\n  // Hide on-page banner and footer\n  document.addEventListener('DOMContentLoaded', function() {\n    // Hide any on-page banner divs\n    const banners = document.querySelectorAll('div[class*=\"banner\"], div[id*=\"banner\"], .banner, #banner');\n    banners.forEach(banner => {\n      if (banner) {\n        banner.style.display = 'none';\n      }\n    });\n    \n    // Hide footer with specific selector\n    const footer = document.querySelector('#aspnetForm > div.site_wrapper > footer');\n    if (footer) {\n      footer.style.display = 'none';\n    }\n    \n    // Also hide any other footer elements as backup\n    const allFooters = document.querySelectorAll('footer');\n    allFooters.forEach(footer => {\n      if (footer && !footer.classList.contains('inner')) {\n        footer.style.display = 'none';\n      }\n    });\n    \n    // Set specific element width to 100%\n    const targetElement = document.querySelector('#main > div.content.clearfix > div > div > div.group_2of3.first');\n    if (targetElement) {\n      targetElement.style.width = '100%';\n    }\n    \n    // Hide and remove sizing from specific elements\n    const firstChild = document.querySelector('#main > div.content.clearfix > div > div > div:nth-child(1)');\n    if (firstChild) {\n      firstChild.style.display = 'none';\n      firstChild.style.width = '0';\n      firstChild.style.height = '0';\n      firstChild.style.margin = '0';\n      firstChild.style.padding = '0';\n    }\n    \n    // Hide navigation\n    const nav = document.querySelector('#main > nav');\n    if (nav) {\n      nav.style.display = 'none';\n    }\n  }); \n" + '</' + 'script>' + "<script>\n(function () {\n  var NEW_NAME = \"ImpactLife\";\n  var OLD_NAME = \"MVRBC\";\n\n  // --- 1) Update JSON-LD (application/ld+json) ---\n  function mutateNames(obj) {\n    if (!obj || typeof obj !== \"object\") return;\n    if (Array.isArray(obj)) {\n      obj.forEach(mutateNames);\n      return;\n    }\n    // Replace exact \"MVRBC\" in common places (and anywhere 'name' equals it)\n    if (typeof obj.name === \"string\" && obj.name.trim() === OLD_NAME) {\n      obj.name = NEW_NAME;\n    }\n    if (obj.author && typeof obj.author === \"object\") {\n      if (typeof obj.author.name === \"string\" && obj.author.name.trim() === OLD_NAME) {\n        obj.author.name = NEW_NAME;\n      }\n    }\n    if (obj.publisher && typeof obj.publisher === \"object\") {\n      if (typeof obj.publisher.name === \"string\" && obj.publisher.name.trim() === OLD_NAME) {\n        obj.publisher.name = NEW_NAME;\n      }\n    }\n    // Recurse through all properties\n    Object.keys(obj).forEach(function (k) {\n      if (obj[k] && typeof obj[k] === \"object\") mutateNames(obj[k]);\n    });\n  }\n\n  Array.prototype.forEach.call(\n    document.querySelectorAll('script[type=\"application/ld+json\"]'),\n    function (node) {\n      try {\n        // Some sites embed minified JSON; keep formatting minimal on write-back\n        var data = JSON.parse(node.textContent.trim());\n        mutateNames(data);\n        node.textContent = JSON.stringify(data);\n      } catch (e) {\n        // Ignore scripts that aren't valid JSON\n      }\n    }\n  );\n\n  // --- 2) (Optional) Replace visible text \"MVRBC\" with \"ImpactLife\" ---\n  // Comment out this block if you only want the JSON-LD change.\n  (function replaceVisibleText() {\n    var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {\n      acceptNode: function (n) {\n        // Skip empty/whitespace text nodes\n        if (!n.nodeValue || !n.nodeValue.trim()) return NodeFilter.FILTER_REJECT;\n        // Skip text under these elements\n        var p = n.parentNode;\n        while (p) {\n          var tag = (p.tagName || \"\").toLowerCase();\n          if (tag === \"script\" || tag === \"style\" || tag === \"noscript\" || tag === \"textarea\") {\n            return NodeFilter.FILTER_REJECT;\n          }\n          p = p.parentNode;\n        }\n        return NodeFilter.FILTER_ACCEPT;\n      }\n    });\n\n    var re = new RegExp(\"\\\\b\" + OLD_NAME.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\") + \"\\\\b\", \"g\");\n    var node;\n    while ((node = walker.nextNode())) {\n      if (re.test(node.nodeValue)) {\n        node.nodeValue = node.nodeValue.replace(re, NEW_NAME);\n      }\n    }\n   })();\n })();\n " + '</' + 'script>' + "<script>\n // Override schema.org data for social media previews\n (function() {\n   // Update any existing JSON-LD schema\n   const jsonLdScripts = document.querySelectorAll('script[type=\"application/ld+json\"]');\n   jsonLdScripts.forEach(script => {\n     try {\n       const data = JSON.parse(script.textContent);\n       if (data.publisher && data.publisher.name === 'MVRBC') {\n         data.publisher.name = 'ImpactLife';\n       }\n       if (data.author && data.author.name === 'MVRBC') {\n         data.author.name = 'ImpactLife';\n       }\n       if (data.name && data.name.includes('MVRBC')) {\n         data.name = data.name.replace(/MVRBC/g, 'ImpactLife');\n       }\n       script.textContent = JSON.stringify(data);\n     } catch (e) {\n       // Ignore invalid JSON\n     }\n   });\n   \n   // Add new schema to override any global schema\n   const newSchema = {\n     \"@context\": \"https://schema.org\",\n     \"@type\": \"Article\",\n     \"headline\": \"Feel-Good News - ImpactLife\",\n     \"description\": \"Stay updated with the latest feel-good news from ImpactLife. Read inspiring stories about blood donation, community impact, and life-saving moments.\",\n     \"publisher\": {\n       \"@type\": \"Organization\",\n       \"name\": \"ImpactLife\",\n       \"url\": \"https://www.bloodcenter.org\"\n     },\n     \"author\": {\n       \"@type\": \"Organization\", \n       \"name\": \"ImpactLife\"\n     },\n     \"datePublished\": \"$SCHEMA_DATE_PUBLISHED\",\n     \"dateModified\": \"$SCHEMA_DATE_MODIFIED\"\n   };\n   \n   const schemaScript = document.createElement('script');\n   schemaScript.type = 'application/ld+json';\n   schemaScript.textContent = JSON.stringify(newSchema);\n   document.head.appendChild(schemaScript);\n })();\n " + '</' + 'script>' + "";
            templateContent = templateString;
        }

// Initialize - add first article
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeTemplate();
                // Don't set default date - require user to manually set it
                // Initialize with empty date
                publicationDate = '';
                publicationDateISO = '';
                
                // Disable article controls until date is set
                disableArticleControls();
                // Set default Employee Spotlight values in form fields
                document.getElementById('employeeSpotlightName').value = employeeSpotlight.name;
                document.getElementById('employeeSpotlightTitle').value = employeeSpotlight.title;
                document.getElementById('employeeSpotlightImageUrl').value = employeeSpotlight.imageUrl;
                // Initialize questions if empty - add default questions
                if (employeeSpotlight.questions.length === 0) {
                    employeeSpotlight.questions = [
                        {question: 'Time at ImpactLife', answer: ''},
                        {question: 'Blood Type', answer: 'O Positive'},
                        {question: 'What runs thru your veins?', answer: ''},
                        {question: 'What\'s your favorite thing about being part of our team?', answer: ''},
                        {question: 'When you are not at work you can be found?', answer: ''}
                    ];
                }
                renderEmployeeSpotlightQuestions();
                // Don't add article automatically - require date first
                // addArticle();
                setupDragDrop();
                // Show initial preview after a short delay
                setTimeout(function() {
                    updateOutputRealTime();
                }, 500);
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing form. Please check the console for details.');
            }
        });

        // Format date from YYYY-MM-DD to "Month Day, Year" format
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const month = months[date.getMonth()];
            const day = date.getDate();
            const year = date.getFullYear();
            
            return month + ' ' + day + ', ' + year;
        }

        // Format date from YYYY-MM-DD to MMDDYYYY format for file paths
        function formatDateMMDDYYYY(dateString) {
            if (!dateString) {
                // Use today's date if no date is set
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const year = today.getFullYear();
                return month + day + year;
            }
            
            const date = new Date(dateString + 'T00:00:00');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            
            return month + day + year;
        }

        function updatePublicationDate(dateString) {
            publicationDate = formatDate(dateString);
            publicationDateISO = dateString || ''; // Store ISO format for schema
            
            // Enable/disable article controls based on whether date is set
            if (dateString && dateString.trim()) {
                enableArticleControls();
            } else {
                disableArticleControls();
            }
            
            updateOutputRealTime(); // Real-time update
        }

        function disableArticleControls() {
            // Show date required message
            const dateMessage = document.getElementById('dateRequiredMessage');
            if (dateMessage) {
                dateMessage.style.display = 'block';
            }
            
            // Disable Add Article button
            const addArticleBtn = document.querySelector('.add-article-btn');
            if (addArticleBtn) {
                addArticleBtn.disabled = true;
                addArticleBtn.style.opacity = '0.5';
                addArticleBtn.style.cursor = 'not-allowed';
                addArticleBtn.title = 'Please set a publication date first';
            }
            
            // Disable Add Thank the Donor button
            const addThankDonorBtn = document.getElementById('addThankDonorBtn');
            if (addThankDonorBtn) {
                addThankDonorBtn.disabled = true;
                addThankDonorBtn.style.opacity = '0.5';
                addThankDonorBtn.style.cursor = 'not-allowed';
                addThankDonorBtn.title = 'Please set a publication date first';
            }
            
            // Disable all article form fields
            articles.forEach(function(article, index) {
                const articleDiv = document.getElementById(article.id);
                if (articleDiv) {
                    const inputs = articleDiv.querySelectorAll('input, textarea, button:not(.btn-danger)');
                    inputs.forEach(function(input) {
                        input.disabled = true;
                        input.style.opacity = '0.5';
                        input.style.cursor = 'not-allowed';
                    });
                    
                    // Disable Quill editors
                    if (quillEditors[article.id]) {
                        quillEditors[article.id].enable(false);
                    }
                }
            });
        }

        function enableArticleControls() {
            // Hide date required message
            const dateMessage = document.getElementById('dateRequiredMessage');
            if (dateMessage) {
                dateMessage.style.display = 'none';
            }
            
            // Enable Add Article button
            const addArticleBtn = document.querySelector('.add-article-btn');
            if (addArticleBtn) {
                addArticleBtn.disabled = false;
                addArticleBtn.style.opacity = '1';
                addArticleBtn.style.cursor = 'pointer';
                addArticleBtn.title = '';
            }
            
            // Enable Add Thank the Donor button
            const addThankDonorBtn = document.getElementById('addThankDonorBtn');
            if (addThankDonorBtn) {
                addThankDonorBtn.disabled = false;
                addThankDonorBtn.style.opacity = '1';
                addThankDonorBtn.style.cursor = 'pointer';
                addThankDonorBtn.title = '';
            }
            
            // Enable all article form fields
            articles.forEach(function(article, index) {
                const articleDiv = document.getElementById(article.id);
                if (articleDiv) {
                    const inputs = articleDiv.querySelectorAll('input, textarea, button:not(.btn-danger)');
                    inputs.forEach(function(input) {
                        input.disabled = false;
                        input.style.opacity = '1';
                        input.style.cursor = '';
                    });
                    
                    // Enable Quill editors
                    if (quillEditors[article.id]) {
                        quillEditors[article.id].enable(true);
                    }
                }
            });
        }

        function updateEmployeeSpotlight(field, value) {
            // Normalize image URLs
            if (field === 'imageUrl' && value) {
                value = normalizeImageUrl(value);
                // Update the input field with normalized value
                const input = document.getElementById('employeeSpotlightImageUrl');
                if (input && input.value !== value) {
                    input.value = value;
                }
            }
            employeeSpotlight[field] = value;
            updateOutputRealTime(); // Real-time update
        }

        function addThankDonor() {
            // Check if publication date is set
            const dateInput = document.getElementById('publicationDate');
            if (!dateInput || !dateInput.value || !dateInput.value.trim()) {
                alert('Please set a publication date before adding a Thank the Donor section.');
                dateInput.focus();
                return;
            }
            
            thankTheDonor.enabled = true;
            thankTheDonor.collapsed = false;
            document.getElementById('addThankDonorBtn').style.display = 'none';
            
            renderThankDonor();
            
            // Initialize Quill editor after a short delay
            setTimeout(function() {
                initThankDonorQuill();
            }, 100);
            
            updateOutputRealTime();
        }

        function removeThankDonor() {
            // Save content from Quill editor before clearing
            if (thankDonorQuill) {
                thankTheDonor.body = thankDonorQuill.root.innerHTML;
            }
            
            thankTheDonor.enabled = false;
            thankTheDonor.collapsed = false;
            thankTheDonor.title = '';
            thankTheDonor.body = '';
            thankTheDonor.imageUrl = '';
            thankTheDonor.imageAlt = '';
            
            // Remove the section from DOM
            const section = document.getElementById(thankTheDonor.id);
            if (section) {
                section.remove();
            }
            
            // Clear Quill editor
            if (thankDonorQuill) {
                thankDonorQuill.root.innerHTML = '';
                thankDonorQuill = null;
            }
            
            document.getElementById('addThankDonorBtn').style.display = 'inline-block';
            
            updateOutputRealTime();
        }

        function renderThankDonor() {
            const container = document.getElementById('articlesContainer');
            if (!container) return;
            
            // Remove existing thank donor section if it exists
            const existing = document.getElementById(thankTheDonor.id);
            if (existing) {
                existing.remove();
            }
            
            // Save Quill content if editor exists
            if (thankDonorQuill) {
                thankTheDonor.body = thankDonorQuill.root.innerHTML;
                thankDonorQuill = null;
            }
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'article-group';
            sectionDiv.id = thankTheDonor.id;
            
            // Build HTML matching article structure (without video/gallery)
            var html = '';
            html += '<div class="article-header" onclick="toggleThankDonor()">';
            html += '<div class="article-header-left">';
            html += '<span class="article-toggle">▼</span>';
            html += '<span class="article-number">Thank the Donor</span>';
            html += '</div>';
            html += '<div class="article-actions" onclick="event.stopPropagation()">';
            html += '<button type="button" class="btn btn-danger btn-small" onclick="removeThankDonor()">Remove</button>';
            html += '</div></div>';
            html += '<div class="article-content">';
            html += '<div class="form-group"><label class="required">Title</label>';
            html += '<input type="text" id="thankDonorTitle" value="' + escapeHtml(thankTheDonor.title) + '" oninput="updateThankDonor(\'title\', this.value)" placeholder="Enter title">';
            html += '<div class="error">Title is required</div></div>';
            html += '<div class="form-group"><label class="required">Body Content</label>';
            html += '<div id="thankDonorContent" class="quill-editor"></div>';
            html += '<div class="error">Body content is required</div></div>';
            html += '<div class="form-group"><label>Image URL</label>';
            html += '<input type="text" id="thankDonorImageUrl" value="' + escapeHtml(thankTheDonor.imageUrl) + '" oninput="updateThankDonor(\'imageUrl\', this.value); validateThankDonorImageAlt()" placeholder="Enter filename only (e.g., image.jpg)">';
            html += '</div>';
            html += '<div class="form-group"><label id="thankDonorImageAltLabel">Image Alt Text</label>';
            html += '<input type="text" id="thankDonorImageAlt" value="' + escapeHtml(thankTheDonor.imageAlt) + '" oninput="updateThankDonor(\'imageAlt\', this.value)" placeholder="Enter image alt text">';
            html += '<div class="error">Image Alt Text is required when Image URL is provided</div></div>';
            html += '</div>'; // Close article-content
            
            sectionDiv.innerHTML = html;
            
            // Set collapsed state
            if (thankTheDonor.collapsed) {
                sectionDiv.classList.add('collapsed');
            }
            
            container.appendChild(sectionDiv);
            
            // Initialize Quill editor
            setTimeout(function() {
                initThankDonorQuill();
            }, 50);
        }

        function toggleThankDonor() {
            thankTheDonor.collapsed = !thankTheDonor.collapsed;
            const section = document.getElementById(thankTheDonor.id);
            if (section) {
                if (thankTheDonor.collapsed) {
                    section.classList.add('collapsed');
                } else {
                    section.classList.remove('collapsed');
                }
            }
        }

        function toggleEmployeeSpotlight() {
            employeeSpotlightCollapsed = !employeeSpotlightCollapsed;
            const section = document.getElementById('employeeSpotlightGroup');
            if (section) {
                const toggleIcon = section.querySelector('.article-toggle');
                
                if (employeeSpotlightCollapsed) {
                    section.classList.add('collapsed');
                    if (toggleIcon) {
                        toggleIcon.textContent = '►';
                    }
                } else {
                    section.classList.remove('collapsed');
                    if (toggleIcon) {
                        toggleIcon.textContent = '▼';
                    }
                }
            }
        }

        function updateThankDonor(field, value) {
            // Normalize image URLs
            if (field === 'imageUrl' && value) {
                value = normalizeImageUrl(value);
                // Update the input field with normalized value
                const input = document.getElementById('thankDonorImageUrl');
                if (input && input.value !== value) {
                    input.value = value;
                }
                validateThankDonorImageAlt();
            }
            thankTheDonor[field] = value;
            updateOutputRealTime(); // Real-time update
        }

        function validateThankDonorImageAlt() {
            const imageUrlInput = document.getElementById('thankDonorImageUrl');
            const imageAltInput = document.getElementById('thankDonorImageAlt');
            const imageAltLabel = document.getElementById('thankDonorImageAltLabel');
            const formGroup = imageAltInput ? imageAltInput.closest('.form-group') : null;

            if (formGroup && imageUrlInput && imageAltInput && imageAltLabel) {
                if (imageUrlInput.value.trim()) {
                    imageAltLabel.classList.add('required');
                    if (!imageAltInput.value.trim()) {
                        formGroup.classList.add('has-error');
                    } else {
                        formGroup.classList.remove('has-error');
                    }
                } else {
                    imageAltLabel.classList.remove('required');
                    formGroup.classList.remove('has-error');
                }
            }
        }

        function initThankDonorQuill() {
            // Wait for Quill to be available
            if (typeof Quill === 'undefined') {
                console.warn('Quill not loaded yet, retrying...');
                setTimeout(function() {
                    initThankDonorQuill();
                }, 500);
                return;
            }
            
            try {
                const editorId = 'thankDonorContent';
                const editorElement = document.getElementById(editorId);
                
                if (!editorElement) {
                    console.warn('Thank Donor editor element not found:', editorId);
                    return;
                }
                
                // Check if already initialized
                if (thankDonorQuill) {
                    return;
                }
                
                // Create Quill instance
                const quill = new Quill(editorElement, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic'],
                            ['link'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                        ]
                    },
                    placeholder: 'Enter body content...'
                });
                
                // Store editor instance
                thankDonorQuill = quill;
                
                // Update thank the donor body on change
                quill.on('text-change', function() {
                    thankTheDonor.body = quill.root.innerHTML;
                    updateOutputRealTime(); // Real-time update
                });
                
                // Set initial content if exists
                if (thankTheDonor.body) {
                    quill.root.innerHTML = thankTheDonor.body;
                }
            } catch (error) {
                console.error('Error initializing Thank Donor Quill:', error);
            }
        }

        function addEmployeeSpotlightQuestion() {
            employeeSpotlight.questions.push({question: '', answer: ''});
            renderEmployeeSpotlightQuestions();
            updateOutputRealTime();
        }

        function removeEmployeeSpotlightQuestion(index) {
            // Allow removing questions even if it's the last one (user can add more)
            employeeSpotlight.questions.splice(index, 1);
            renderEmployeeSpotlightQuestions();
            updateOutputRealTime();
        }

        function updateEmployeeSpotlightQuestion(index, field, value) {
            employeeSpotlight.questions[index][field] = value;
            updateOutputRealTime();
        }

        function renderEmployeeSpotlightQuestions() {
            const container = document.getElementById('employeeSpotlightQuestions');
            if (!container) return;
            
            container.innerHTML = '';
            
            employeeSpotlight.questions.forEach((qa, index) => {
                const qaDiv = document.createElement('div');
                qaDiv.className = 'employee-spotlight-qa';
                qaDiv.style.cssText = 'margin-bottom: 16px; padding: 16px; background: #f6f7f9; border-radius: 8px;';
                
                const questionGroup = document.createElement('div');
                questionGroup.className = 'form-group';
                questionGroup.style.cssText = 'margin-bottom: 12px;';
                
                const questionLabel = document.createElement('label');
                questionLabel.className = 'required';
                questionLabel.textContent = 'Question ' + (index + 1);
                questionGroup.appendChild(questionLabel);
                
                const questionInput = document.createElement('input');
                questionInput.type = 'text';
                questionInput.value = qa.question || '';
                questionInput.placeholder = 'Enter question';
                questionInput.style.cssText = 'width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;';
                questionInput.oninput = function() {
                    updateEmployeeSpotlightQuestion(index, 'question', this.value);
                };
                questionGroup.appendChild(questionInput);
                
                const answerGroup = document.createElement('div');
                answerGroup.className = 'form-group';
                answerGroup.style.cssText = 'margin-bottom: 0;';
                
                const answerLabel = document.createElement('label');
                answerLabel.className = 'required';
                answerLabel.textContent = 'Answer ' + (index + 1);
                answerGroup.appendChild(answerLabel);
                
                const answerInput = document.createElement('input');
                answerInput.type = 'text';
                answerInput.value = qa.answer || '';
                answerInput.placeholder = 'Enter answer';
                answerInput.style.cssText = 'width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;';
                answerInput.oninput = function() {
                    updateEmployeeSpotlightQuestion(index, 'answer', this.value);
                };
                answerGroup.appendChild(answerInput);
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-small';
                removeBtn.textContent = 'Remove';
                removeBtn.style.cssText = 'margin-top: 8px;';
                removeBtn.onclick = function() {
                    removeEmployeeSpotlightQuestion(index);
                };
                
                qaDiv.appendChild(questionGroup);
                qaDiv.appendChild(answerGroup);
                qaDiv.appendChild(removeBtn);
                
                container.appendChild(qaDiv);
            });
        }

        function addArticle() {
            // Check if publication date is set
            const dateInput = document.getElementById('publicationDate');
            if (!dateInput || !dateInput.value || !dateInput.value.trim()) {
                alert('Please set a publication date before adding articles.');
                dateInput.focus();
                return;
            }
            
            try {
                console.log('addArticle called');
                const articleId = 'article-' + articleCounter++;
                const article = {
                    id: articleId,
                    title: '',
                    body: '',
                    imageUrl: '',
                    imageAlt: '',
                    videoUrl: '',
                    galleryUrls: [],
                    collapsed: false // Track accordion state
                };
                articles.push(article);
                console.log('Article added, total articles:', articles.length);

                renderArticles();
                setupDragDrop();
                updateOutputRealTime(); // Real-time update after adding article
            } catch (error) {
                console.error('Error adding article:', error);
                alert('Error adding article: ' + error.message);
            }
        }

        function removeArticle(index) {
            if (articles.length <= 1) {
                alert('You must have at least one article.');
                return;
            }

            const articleId = articles[index].id;
            if (quillEditors[articleId]) {
                quillEditors[articleId] = null;
                delete quillEditors[articleId];
            }

            articles.splice(index, 1);
            renderArticles();
            setupDragDrop();
            updateOutputRealTime(); // Real-time update after removing article
        }

        function addGalleryImage(articleIndex) {
            articles[articleIndex].galleryUrls.push('');
            renderArticles();
            // Validate image alt after rendering
            setTimeout(function() {
                validateImageAlt(articleIndex);
            }, 100);
            updateOutputRealTime(); // Real-time update
        }

        function removeGalleryImage(articleIndex, imageIndex) {
            articles[articleIndex].galleryUrls.splice(imageIndex, 1);
            renderArticles();
            // Validate image alt after rendering
            setTimeout(function() {
                validateImageAlt(articleIndex);
            }, 100);
            updateOutputRealTime(); // Real-time update
        }

        function handleGalleryUpload(articleIndex, files) {
            if (!files || files.length === 0) {
                return;
            }

            // Check if publication date is set
            const dateInput = document.getElementById('publicationDate');
            if (!dateInput || !dateInput.value || !dateInput.value.trim()) {
                alert('Please set a publication date before uploading gallery images.');
                dateInput.focus();
                return;
            }

            // Get publication date and format as MMDDYYYY
            const dateString = dateInput.value;
            const datePath = formatDateMMDDYYYY(dateString);
            
            // Base URL for images
            const baseUrl = 'https://www.bloodcenter.org/webres/Image/FGN/' + datePath + '/';
            
            // Extract filenames and construct URLs
            const newUrls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = file.name;
                // URL encode the filename in case it has special characters
                const encodedFileName = encodeURIComponent(fileName);
                const fullUrl = baseUrl + encodedFileName;
                newUrls.push(fullUrl);
            }
            
            // Add all new URLs to the article's gallery
            if (!articles[articleIndex].galleryUrls) {
                articles[articleIndex].galleryUrls = [];
            }
            articles[articleIndex].galleryUrls = articles[articleIndex].galleryUrls.concat(newUrls);
            
            // Clear the file input
            const fileInput = document.getElementById('gallery-upload-' + articles[articleIndex].id);
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Re-render articles to show new URLs
            renderArticles();
            // Validate image alt after rendering
            setTimeout(function() {
                validateImageAlt(articleIndex);
            }, 100);
            updateOutputRealTime();
        }

        function renderArticles() {
            const container = document.getElementById('articlesContainer');
            if (!container) {
                console.error('articlesContainer not found!');
                return;
            }
            
            // Save content from existing Quill editors before clearing
            articles.forEach(function(article) {
                if (quillEditors[article.id]) {
                    // Save the current content from the Quill editor
                    article.body = quillEditors[article.id].root.innerHTML;
                    // Destroy the Quill instance
                    quillEditors[article.id] = null;
                    delete quillEditors[article.id];
                }
            });
            
            container.innerHTML = '';

            articles.forEach((article, index) => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'article-group';
                articleDiv.id = article.id;
                articleDiv.draggable = true;
                
                // Initialize collapsed property if it doesn't exist
                if (typeof article.collapsed === 'undefined') {
                    article.collapsed = false;
                }

                const order = index + 1;

                // Build gallery HTML separately
                var galleryHtml = '';
                article.galleryUrls.forEach(function(url, imgIndex) {
                    galleryHtml += '<div class="gallery-item">';
                    galleryHtml += '<input type="text" value="' + escapeHtml(url) + '" oninput="updateGalleryImage(' + index + ', ' + imgIndex + ', this.value)" placeholder="Enter filename only (e.g., image.jpg)">';
                    galleryHtml += '<button type="button" class="btn btn-danger btn-small" onclick="removeGalleryImage(' + index + ', ' + imgIndex + ')">Remove</button>';
                    galleryHtml += '</div>';
                });

                // Build HTML using string concatenation to avoid template literal parsing issues
                var html = '';
                html += '<div class="article-header" onclick="toggleArticle(' + index + ')">';
                html += '<div class="article-header-left">';
                html += '<span class="article-toggle">▼</span>';
                // Use article title if available, otherwise fall back to "Article X"
                const headerText = article.title && article.title.trim() ? escapeHtml(article.title.trim()) : 'Article ' + order;
                html += '<span class="article-number" id="article-number-' + article.id + '">' + headerText + '</span>';
                html += '</div>';
                html += '<div class="article-actions" onclick="event.stopPropagation()">';
                html += '<span class="drag-handle" title="Drag to reorder">⋮⋮</span>';
                html += '<button type="button" class="btn btn-danger btn-small" onclick="removeArticle(' + index + ')">Remove</button>';
                html += '</div></div>';
                html += '<div class="article-content">';
                html += '<div class="form-group"><label class="required">Title</label>';
                html += '<input type="text" id="title-' + article.id + '" value="' + escapeHtml(article.title) + '" oninput="updateArticle(' + index + ', &quot;title&quot;, this.value)" placeholder="Enter article title">';
                html += '<div class="error">Title is required</div></div>';
                html += '<div class="form-group"><label class="required">Body Content</label>';
                // Don't escape HTML here - Quill will handle it, but we need to set it as innerHTML after Quill is initialized
                html += '<div id="body-' + article.id + '" class="quill-editor"></div>';
                html += '<div class="error">Body content is required</div></div>';
                html += '<div class="form-group"><label>Video URL</label>';
                html += '<input type="text" id="videoUrl-' + article.id + '" value="' + escapeHtml(article.videoUrl) + '" oninput="updateArticle(' + index + ', &quot;videoUrl&quot;, this.value)" placeholder="Enter video URL (YouTube, Vimeo, etc.)">';
                html += '</div>';
                html += '<div class="gallery-section">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                html += '<label style="margin: 0;">Images<span class="tooltip-wrapper"><span class="tooltip-icon">?</span><span class="tooltip-text">Add one image for a single photo, or multiple images for a slideshow gallery.</span></span></label>';
                html += '<div style="display: flex; gap: 8px;">';
                html += '<button type="button" class="btn btn-secondary btn-small" onclick="addGalleryImage(' + index + ')">+ Add Image</button>';
                html += '<label for="gallery-upload-' + article.id + '" class="btn btn-secondary btn-small" style="margin: 0; cursor: pointer;">📁 Upload Files</label>';
                html += '<input type="file" id="gallery-upload-' + article.id + '" multiple accept="image/*" style="display: none;" onchange="handleGalleryUpload(' + index + ', this.files)">';
                html += '</div>';
                html += '</div>';
                html += '<div id="gallery-' + article.id + '">' + galleryHtml + '</div>';
                html += '<div class="form-group" style="margin-top: 12px;"><label id="imageAltLabel-' + article.id + '">Image Alt Text<span class="tooltip-wrapper"><span class="tooltip-icon">?</span><span class="tooltip-text">Describe the image with your eyes closed to help out friends with visual impairments.</span></span></label>';
                html += '<input type="text" id="imageAlt-' + article.id + '" value="' + escapeHtml(article.imageAlt || '') + '" oninput="updateArticle(' + index + ', &quot;imageAlt&quot;, this.value)" placeholder="Enter image alt text">';
                html += '<div class="error">Image Alt Text is required when images are provided</div></div>';
                html += '</div>';
                html += '</div>'; // Close article-content
                
                articleDiv.innerHTML = html;
                
                // Set collapsed state
                if (article.collapsed) {
                    articleDiv.classList.add('collapsed');
                }

                container.appendChild(articleDiv);
            });
            
            // Reinitialize all Quill editors after rendering
            setTimeout(function() {
                articles.forEach(function(article, index) {
                    initQuill(article.id);
                    // Validate image alt for each article
                    validateImageAlt(index);
                });
                
                // Re-render Thank the Donor section if enabled
                if (thankTheDonor.enabled) {
                    renderThankDonor();
                }
                
                // Disable/enable article controls based on date
                const dateInput = document.getElementById('publicationDate');
                if (!dateInput || !dateInput.value || !dateInput.value.trim()) {
                    disableArticleControls();
                } else {
                    enableArticleControls();
                }
            }, 50);
        }

        function toggleArticle(index) {
            const article = articles[index];
            article.collapsed = !article.collapsed;
            
            const articleDiv = document.getElementById(article.id);
            if (articleDiv) {
                if (article.collapsed) {
                    articleDiv.classList.add('collapsed');
                } else {
                    articleDiv.classList.remove('collapsed');
                }
            }
        }

        function updateArticle(index, field, value) {
            articles[index][field] = value;
            
            // Update article header text when title changes
            if (field === 'title') {
                const article = articles[index];
                const headerElement = document.getElementById('article-number-' + article.id);
                if (headerElement) {
                    const order = index + 1;
                    headerElement.textContent = value && value.trim() ? value.trim() : 'Article ' + order;
                }
            }
            
            // Validate image alt when imageAlt field changes
            if (field === 'imageAlt') {
                validateImageAlt(index);
            }
            
            validateForm();
            updateOutputRealTime(); // Real-time update
        }

        function updateGalleryImage(articleIndex, imageIndex, value) {
            // Normalize gallery image URLs
            if (value) {
                value = normalizeImageUrl(value);
                // Update the input field with normalized value
                const article = articles[articleIndex];
                const galleryContainer = document.getElementById('gallery-' + article.id);
                if (galleryContainer) {
                    const inputs = galleryContainer.querySelectorAll('input[type="text"]');
                    if (inputs[imageIndex] && inputs[imageIndex].value !== value) {
                        inputs[imageIndex].value = value;
                    }
                }
            }
            articles[articleIndex].galleryUrls[imageIndex] = value;
            // Validate image alt when gallery images change
            validateImageAlt(articleIndex);
            updateOutputRealTime(); // Real-time update
        }

        function validateImageAlt(index) {
            const article = articles[index];
            const imageAltInput = document.getElementById('imageAlt-' + article.id);
            const imageAltLabel = document.getElementById('imageAltLabel-' + article.id);
            const formGroup = imageAltInput ? imageAltInput.closest('.form-group') : null;

            if (!formGroup || !imageAltInput || !imageAltLabel) {
                return;
            }

            // Check if gallery images exist
            const hasGalleryImages = article.galleryUrls && article.galleryUrls.length > 0 && article.galleryUrls.some(url => url && url.trim());
            
            // Require Image Alt if gallery images exist
            if (hasGalleryImages) {
                imageAltLabel.classList.add('required');
                if (!imageAltInput.value.trim()) {
                    formGroup.classList.add('has-error');
                } else {
                    formGroup.classList.remove('has-error');
                }
            } else {
                // If no gallery images, Image Alt is not required
                imageAltLabel.classList.remove('required');
                formGroup.classList.remove('has-error');
            }
        }

        function validateForm() {
            let isValid = true;

            articles.forEach((article, index) => {
                const titleInput = document.getElementById('title-' + article.id);
                const bodyInput = document.getElementById('body-' + article.id);
                const imageAltInput = document.getElementById('imageAlt-' + article.id);

                // Validate title
                const titleGroup = titleInput.closest('.form-group');
                if (!article.title.trim()) {
                    titleGroup.classList.add('has-error');
                    isValid = false;
                } else {
                    titleGroup.classList.remove('has-error');
                }

                // Validate body
                const bodyGroup = document.getElementById('body-' + article.id).closest('.form-group');
                let bodyContent = '';
                if (quillEditors[article.id]) {
                    bodyContent = quillEditors[article.id].root.innerHTML;
                } else {
                    const bodyElement = document.getElementById('body-' + article.id);
                    bodyContent = bodyElement ? bodyElement.innerHTML : '';
                }

                if (!bodyContent.trim()) {
                    bodyGroup.classList.add('has-error');
                    isValid = false;
                } else {
                    bodyGroup.classList.remove('has-error');
                }

                // Validate image alt if image URL exists
                validateImageAlt(index);
            });

            return isValid;
        }

        function initQuill(articleId) {
            // Wait for Quill to be available
            if (typeof Quill === 'undefined') {
                console.warn('Quill not loaded yet, retrying...');
                setTimeout(function() {
                    initQuill(articleId);
                }, 500);
                return;
            }
            
            try {
                const editorId = 'body-' + articleId;
                const editorElement = document.getElementById(editorId);
                
                if (!editorElement) {
                    console.warn('Editor element not found:', editorId);
                    return;
                }
                
                // Check if already initialized
                if (quillEditors[articleId]) {
                    return;
                }
                
                // Create Quill instance
                const quill = new Quill(editorElement, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic'],
                            ['link'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                        ]
                    },
                    placeholder: 'Enter article body content...'
                });
                
                // Store editor instance
                quillEditors[articleId] = quill;
                
                // Update article body on change
                quill.on('text-change', function() {
                    const index = articles.findIndex(function(a) {
                        return a.id === articleId;
                    });
                    if (index !== -1) {
                        articles[index].body = quill.root.innerHTML;
                        validateForm();
                        updateOutputRealTime(); // Real-time update
                    }
                });
                
                // Set initial content if exists
                const article = articles.find(function(a) {
                    return a.id === articleId;
                });
                if (article && article.body) {
                    quill.root.innerHTML = article.body;
                }
            } catch (error) {
                console.error('Error initializing Quill:', error);
            }
        }


        function slugify(text) {
            return text
                .toString()
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Normalize image URLs to always start with https://www.bloodcenter.org
        function normalizeImageUrl(url) {
            if (!url || !url.trim()) {
                return '';
            }
            
            url = url.trim();
            
            // If it already starts with http:// or https://, return as-is
            if (url.match(/^https?:\/\//i)) {
                return url;
            }
            
            // If it starts with //, prepend https:
            if (url.startsWith('//')) {
                return 'https:' + url;
            }
            
            // If it starts with /, prepend the domain (full path provided)
            if (url.startsWith('/')) {
                return 'https://www.bloodcenter.org' + url;
            }
            
            // Otherwise, treat it as just a filename and construct the full path
            // Get the publication date from the date input
            const dateInput = document.getElementById('publicationDate');
            let datePath = '';
            if (dateInput && dateInput.value && dateInput.value.trim()) {
                datePath = formatDateMMDDYYYY(dateInput.value);
            } else {
                // Fallback to today's date if no date is set
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const year = today.getFullYear();
                datePath = month + day + year;
            }
            
            // Construct the full URL: https://www.bloodcenter.org/webres/Image/FGN/MMDDYYYY/filename
            return 'https://www.bloodcenter.org/webres/Image/FGN/' + datePath + '/' + url;
        }

        function convertToEmbedUrl(url) {
            if (!url || !url.trim()) {
                return url;
            }
            
            url = url.trim();
            
            // YouTube URL conversion
            // Match: youtube.com/watch?v=VIDEO_ID or youtube.com/watch?feature=...&v=VIDEO_ID
            let youtubeMatch = url.match(/(?:youtube\.com\/watch\?.*v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]+)/);
            if (youtubeMatch) {
                return 'https://www.youtube.com/embed/' + youtubeMatch[1];
            }
            
            // Vimeo URL conversion
            // Match: vimeo.com/VIDEO_ID or player.vimeo.com/video/VIDEO_ID
            let vimeoMatch = url.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)/);
            if (vimeoMatch) {
                return 'https://player.vimeo.com/video/' + vimeoMatch[1];
            }
            
            // If already in embed format or unknown format, return as-is
            return url;
        }

        function loadTemplate() {
            // Template is now embedded directly - no need to fetch
            // This function kept for backwards compatibility but does nothing
        }

        function generateOutput() {
            if (!validateForm()) {
                alert('Please fix validation errors before generating output.');
                return;
            }

            if (!templateContent) {
                alert('Template not loaded yet. Please wait a moment and try again.');
                return;
            }

            generateOutputCore(true);
        }

        // Core generation function that can run with or without validation
        function generateOutputCore(showScroll) {
            if (!templateContent) {
                return;
            }

            let output = templateContent;

            // Replace publication date placeholder
            const datePattern = '\\$FORMVALUE_PUBLICATION_DATE';
            output = output.replace(new RegExp(datePattern, 'g'), publicationDate || 'October 24, 2025');
            
            // Replace schema date placeholders with ISO format date
            const schemaDatePublished = publicationDateISO || '2025-10-24';
            const schemaDateModified = publicationDateISO || '2025-10-24';
            output = output.replace(/\$SCHEMA_DATE_PUBLISHED/g, schemaDatePublished);
            output = output.replace(/\$SCHEMA_DATE_MODIFIED/g, schemaDateModified);

            // Replace Employee Spotlight placeholders
            // Format questions and answers consistently
            let employeeContent = '';
            if (employeeSpotlight.questions && employeeSpotlight.questions.length > 0) {
                const qaPairs = employeeSpotlight.questions
                    .filter(qa => qa.question && qa.question.trim() && qa.answer && qa.answer.trim())
                    .map(qa => {
                        return '<strong>' + escapeHtml(qa.question.trim()) + '</strong><br>' + escapeHtml(qa.answer.trim());
                    });
                employeeContent = qaPairs.join('<br><br>');
            }
            
            output = output.replace(/\$EMPLOYEE_SPOTLIGHT_NAME/g, escapeHtml(employeeSpotlight.name || ''));
            output = output.replace(/\$EMPLOYEE_SPOTLIGHT_TITLE/g, escapeHtml(employeeSpotlight.title || ''));
            output = output.replace(/\$EMPLOYEE_SPOTLIGHT_URL/g, escapeHtml(normalizeImageUrl(employeeSpotlight.imageUrl || '')));
            output = output.replace(/\$EMPLOYEE_SPOTLIGHT_CONTENT/g, employeeContent);

            // Find the first article that has gallery URLs (image URL is optional)
            let galleryArticle = null;
            let galleryImageId = '';
            let galleryUrls = [];
            
            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                const hasGallery = article.galleryUrls && article.galleryUrls.some(url => url && url.trim());
                
                if (hasGallery) {
                    galleryArticle = article;
                    galleryImageId = article.title.trim() ? slugify(article.title) : '';
                    galleryUrls = article.galleryUrls.filter(url => url && url.trim()).map(url => normalizeImageUrl(url.trim()));
                    break; // Use the first article that has gallery URLs
                }
            }

            // Remove unused article blocks FIRST (before placeholder replacement)
            // This removes placeholder articles that don't have values
            // Remove articles from Story 01 to Story 99 that aren't being used
            for (let i = articles.length + 1; i <= 99; i++) {
                const num = String(i).padStart(2, '0');
                // Match article comment and everything until closing article tag (including whitespace/newlines)
                // Use a more robust pattern that handles whitespace variations
                const articleRegexPattern = '<!-- Story ' + num + ' -->[\\s\\S]*?<\\/article>\\s*';
                const articleRegex = new RegExp(articleRegexPattern, 'g');
                output = output.replace(articleRegex, '');
            }
            
            // Also remove any articles that still have placeholder values (in case removal above missed some)
            // This is a safety net for articles that might have been partially filled
            const placeholderPattern = '<article[^>]*>[\\s\\S]*?\\$FORMVALUE_TITLE_[\\d]+[\\s\\S]*?<\\/article>';
            output = output.replace(new RegExp(placeholderPattern, 'g'), '');
            
            // Clean up any empty article tags or whitespace-only articles
            output = output.replace(/<article[^>]*>\s*<\/article>/g, '');
            output = output.replace(/<article[^>]*>\s*<h2>\s*<\/h2>\s*<\/article>/g, '');

            // Process each article
            articles.forEach(function(article, index) {
                const articleNumber = String(index + 1).padStart(2, '0');
                const order = index + 1;
                const imageId = article.title.trim() ? slugify(article.title) : '';

                // Get body content from Quill or div
                let bodyContent = '';
                if (quillEditors[article.id]) {
                    bodyContent = quillEditors[article.id].root.innerHTML;
                } else {
                    const bodyElement = document.getElementById('body-' + article.id);
                    bodyContent = bodyElement ? bodyElement.innerHTML : '';
                }

                // Replace placeholders (for backwards compatibility - articles are rebuilt dynamically below)
                const titlePattern = '\\$FORMVALUE_TITLE_' + articleNumber;
                const bodyPattern = '\\$FORMVALUE_BODY_CONTENT_' + articleNumber;
                const videoUrlPattern = '\\$FORMVALUE_VIDEO_URL_' + articleNumber;
                
                output = output.replace(new RegExp(titlePattern, 'g'), escapeHtml(article.title));
                output = output.replace(new RegExp(bodyPattern, 'g'), bodyContent);
                
                // Remove old image URL placeholders (no longer used - using galleryUrls exclusively)
                const imageUrlPattern = '\\$FORMVALUE_IMAGE_URL_' + articleNumber;
                const imageAltPattern = '\\$FORMVALUE_IMAGE_ALT_' + articleNumber;
                const imageIdPattern = '\\$FORMVALUE_IMAGE_ID_' + articleNumber;
                    const emptyImagePattern = '<img[^>]*src="\\$FORMVALUE_IMAGE_URL_' + articleNumber + '"[^>]*\\s*/>';
                    output = output.replace(new RegExp(emptyImagePattern, 'g'), '');
                    output = output.replace(new RegExp(imageAltPattern, 'g'), '');
                    output = output.replace(new RegExp(imageIdPattern, 'g'), '');
                    output = output.replace(new RegExp(imageUrlPattern, 'g'), '');
                
                if (article.videoUrl.trim()) {
                    // Convert video URL to embed format
                    const embedUrl = convertToEmbedUrl(article.videoUrl);
                    output = output.replace(new RegExp(videoUrlPattern, 'g'), escapeHtml(embedUrl));
                } else {
                    // Remove empty video containers - match video-container div with placeholder URL
                    const emptyVideoPattern = '<div[^>]*class="video-container"[^>]*>\\s*<iframe[^>]*src="\\$FORMVALUE_VIDEO_URL_' + articleNumber + '"[^>]*>\\s*</iframe>\\s*</div>';
                    output = output.replace(new RegExp(emptyVideoPattern, 'g'), '');
                    // Also remove just the placeholder URL
                    output = output.replace(new RegExp(videoUrlPattern, 'g'), '');
                }

                // Update article order in template - skip this as we rebuild the structure anyway
                // This section is kept for backwards compatibility but won't be used
            });

            // Clean up any empty media containers that might have been left after placeholder replacement
            // Remove empty image tags (img tags with empty or missing src)
            output = output.replace(/<img[^>]*src=""[^>]*\s*\/?>/g, '');
            output = output.replace(/<img[^>]*src="\$FORMVALUE_IMAGE_URL[^"]*"[^>]*\s*\/?>/g, '');
            // Remove empty video containers
            output = output.replace(/<div[^>]*class="video-container"[^>]*>\s*<iframe[^>]*src=""[^>]*>.*?<\/iframe>\s*<\/div>/g, '');
            output = output.replace(/<div[^>]*class="video-container"[^>]*>\s*<iframe[^>]*src="\$FORMVALUE_VIDEO_URL[^"]*"[^>]*>.*?<\/iframe>\s*<\/div>/g, '');
            // Remove empty media divs
            output = output.replace(/<div[^>]*class="media[^"]*"[^>]*>\s*<\/div>/g, '');

            // Handle gallery URLs - create a script for EACH article that has gallery images
            // First, remove the old single gallery script
                const formGalleryMarker = '// Form Gallery';
                const formGalleryIndex = output.indexOf(formGalleryMarker);
                if (formGalleryIndex !== -1) {
                    let scriptStart = output.lastIndexOf('<script>', formGalleryIndex);
                    if (scriptStart === -1) {
                    scriptStart = output.lastIndexOf('<script', formGalleryIndex);
                }
                                const scriptEndTag = '</' + 'script>';
                const scriptEnd = output.indexOf(scriptEndTag, formGalleryIndex);
                if (scriptStart !== -1 && scriptEnd !== -1) {
                    output = output.substring(0, scriptStart) + output.substring(scriptEnd + 9);
                }
            }
            
            // Now create gallery scripts for each article that has gallery images
            // Find where to insert the scripts (before the "Hide on-page banner" script)
            const hideBannerMarker = '// Hide on-page banner and footer';
            const hideBannerIndex = output.indexOf(hideBannerMarker);
            
            if (hideBannerIndex !== -1) {
                // Build all gallery scripts
                let allGalleryScripts = '';
                articles.forEach(function(article, index) {
                    const articleGalleryUrls = article.galleryUrls ? article.galleryUrls.filter(url => url && url.trim()).map(url => normalizeImageUrl(url.trim())) : [];
                    // Only create slideshow script if there are 2+ images (1 image = single photo, no slideshow)
                    if (articleGalleryUrls.length > 1) {
                        // Generate image ID - use title if available, otherwise use article number
                        let articleImageId = article.title.trim() ? slugify(article.title) : '';
                        if (!articleImageId) {
                            const articleNumber = String(index + 1).padStart(2, '0');
                            articleImageId = 'article-' + articleNumber;
                        }
                        // Convert hyphens to underscores for valid JS identifier (hyphens aren't valid in JS var names)
                        const jsSafeId = articleImageId.replace(/-/g, '_');
                        // Ensure jsSafeId is valid (not empty and valid JS identifier)
                        if (jsSafeId && jsSafeId.length > 0 && /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(jsSafeId)) {
                            const galleryUrlsString = articleGalleryUrls.map(function(url) {
                                return '"' + escapeHtml(url) + '"';
                            }).join(',\n      ');
                            
                            // Ensure we have URLs to work with
                            if (galleryUrlsString && galleryUrlsString.trim().length > 0) {
                                const scriptParts = [
                                    'document.addEventListener("DOMContentLoaded", function() {',
                                    '    // Gallery for: ' + escapeHtml(article.title),
                                    '    const formImages_' + jsSafeId + ' = [',
                                    '      ' + galleryUrlsString,
                                    '    ];',
                                    '    let formIndex_' + jsSafeId + ' = 0;',
                                    '    ',
                                    '    function initGallery_' + jsSafeId + '() {',
                                    '      const formImg = document.getElementById("' + articleImageId + '");',
                                    '      if (formImg && formImages_' + jsSafeId + '.length > 0) {',
                                    '        if (!formImg.src || formImg.src === "") {',
                                    '          formImg.src = formImages_' + jsSafeId + '[0];',
                                    '        }',
                                    '        ',
                                    '        setInterval(function () {',
                                    '          formImg.style.opacity = 0;',
                                    '          setTimeout(function() {',
                                    '            formIndex_' + jsSafeId + ' = (formIndex_' + jsSafeId + ' + 1) % formImages_' + jsSafeId + '.length;',
                                    '            formImg.src = formImages_' + jsSafeId + '[formIndex_' + jsSafeId + '];',
                                    '            formImg.style.opacity = 1;',
                                    '          }, 1000);',
                                    '        }, 5000);',
                                    '      } else if (formImages_' + jsSafeId + '.length > 0) {',
                                    '        setTimeout(initGallery_' + jsSafeId + ', 100);',
                                    '      }',
                                    '    }',
                                    '    ',
                                    '    initGallery_' + jsSafeId + '();',
                                    '  });'
                                ];
                                const scriptTagOpen = '<' + 'script>';
                                const scriptTagClose = '</' + 'script>';
                                allGalleryScripts += scriptTagOpen + '\n  ' + scriptParts.join('\n') + '\n' + scriptTagClose + '\n';
                            }
                        }
                    }
                });
                
                // Insert all gallery scripts before the "Hide on-page banner" script
                if (allGalleryScripts) {
                    // Find the script tag start for the hide banner script
                    let bannerScriptStart = output.lastIndexOf('<script>', hideBannerIndex);
                    if (bannerScriptStart === -1) {
                        bannerScriptStart = output.lastIndexOf('<script', hideBannerIndex);
                    }
                    if (bannerScriptStart !== -1) {
                        output = output.substring(0, bannerScriptStart) + allGalleryScripts + output.substring(bannerScriptStart);
                    } else {
                        // If we can't find the script tag, insert before the marker
                        output = output.substring(0, hideBannerIndex) + allGalleryScripts + output.substring(hideBannerIndex);
                    }
                }
            }

            // Note: Unused article blocks were already removed above, before placeholder replacement

            // Update gallery URL placeholders (remove unused ones) - clean up any remaining placeholders
            for (let i = 1; i <= 99; i++) {
                const num = String(i).padStart(2, '0');
                const galleryUrlPattern = '\\$FORMVALUE_IMAGE_GALLERY_URL_' + num;
                output = output.replace(new RegExp(galleryUrlPattern, 'g'), '');
            }

            // Collect all articles in order for masonry layout
            const allArticles = [];

            articles.forEach((article, index) => {
                const order = index + 1;
                const articleNumber = String(order).padStart(2, '0');
                
                let bodyContent = '';
                if (quillEditors[article.id]) {
                    bodyContent = quillEditors[article.id].root.innerHTML;
                } else {
                    const bodyElement = document.getElementById('body-' + article.id);
                    bodyContent = bodyElement ? bodyElement.innerHTML : '';
                }

                // Check if we have gallery images
                const hasGalleryImages = article.galleryUrls && article.galleryUrls.length > 0 && article.galleryUrls.some(url => url && url.trim());
                const galleryImageCount = hasGalleryImages ? article.galleryUrls.filter(url => url && url.trim()).length : 0;
                
                // Generate image ID - only needed if there are 2+ images (for slideshow)
                let imageId = '';
                if (galleryImageCount > 1) {
                    // Only add ID if there are 2+ images (for slideshow script)
                    imageId = article.title.trim() ? slugify(article.title) : '';
                    if (!imageId) {
                        imageId = 'article-' + articleNumber;
                    }
                }
                
                let mediaContent = '';
                // Use gallery images only (single image field removed - now using galleryUrls for all images)
                if (hasGalleryImages) {
                    const firstGalleryImage = article.galleryUrls.find(url => url && url.trim());
                    if (firstGalleryImage) {
                        const imageSrc = normalizeImageUrl(firstGalleryImage.trim());
                        let imageAlt = article.imageAlt || '';
                        if (!imageAlt && article.title) {
                            imageAlt = article.title;
                        }
                        // Only add ID if there are 2+ images (for slideshow)
                        if (galleryImageCount > 1) {
                            mediaContent += '<img class="masonry-image" alt="' + escapeHtml(imageAlt) + '" id="' + imageId + '" src="' + escapeHtml(imageSrc) + '" />';
                        } else {
                            // Single image - no ID needed (no slideshow)
                            mediaContent += '<img class="masonry-image" alt="' + escapeHtml(imageAlt) + '" src="' + escapeHtml(imageSrc) + '" />';
                        }
                    }
                }
                // Only add video if URL has a value
                if (article.videoUrl && article.videoUrl.trim()) {
                    // Convert video URL to embed format
                    const embedUrl = convertToEmbedUrl(article.videoUrl);
                    mediaContent += '<div class="video-container">\n          <iframe width="560" height="315" src="' + escapeHtml(embedUrl) + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>\n        </div>';
                }

                // Determine media class based on what's actually present
                let mediaClass = '';
                const hasImage = hasGalleryImages;
                const hasVideo = article.videoUrl && article.videoUrl.trim();
                if (hasImage && hasVideo) {
                    mediaClass = ''; // Both present - use default grid
                } else if (hasImage || hasVideo) {
                    mediaClass = 'single'; // Only one present
                }
                
                // Only add media wrapper if there's actual content
                let mediaHtml = '';
                if (mediaContent && mediaContent.trim()) {
                    mediaHtml = '<div class="media ' + mediaClass + '">\n        ' + mediaContent + '\n      </div>';
                }
                
                const articleHtml = '\n    <!-- Story ' + articleNumber + ' -->\n    <article class="card masonry-item" style="order: ' + order + ';">\n      <h2>' + escapeHtml(article.title) + '</h2>\n      <p>' + bodyContent + '</p>\n      ' + mediaHtml + '\n    </article>';

                allArticles.push(articleHtml);
            });

            // Replace the main content area with single container for masonry
            const mainGridRegex = /<div class="main-grid">([\s\S]*?)<\/div>/;
            const allArticlesHtml = allArticles.join('\n');
            
            const newMainGrid = '<div class="main-grid">\n' + allArticlesHtml + '\n</div>';

            output = output.replace(mainGridRegex, newMainGrid);

            // Add Thank the Donor section and wrap with Employee Spotlight if enabled
            if (thankTheDonor.enabled && thankTheDonor.title && thankTheDonor.title.trim()) {
                // Get body content from Quill editor if available
                let thankDonorBody = '';
                if (thankDonorQuill) {
                    thankDonorBody = thankDonorQuill.root.innerHTML;
                } else {
                    // Try to get from the editor element if Quill isn't initialized yet
                    const editorElement = document.getElementById('thankDonorContent');
                    if (editorElement) {
                        thankDonorBody = editorElement.innerHTML;
                    } else {
                        thankDonorBody = thankTheDonor.body || '';
                    }
                }
                
                let thankDonorMediaHtml = '';
                if (thankTheDonor.imageUrl && thankTheDonor.imageUrl.trim()) {
                    const imageSrc = normalizeImageUrl(thankTheDonor.imageUrl);
                    const imageAlt = thankTheDonor.imageAlt || thankTheDonor.title;
                    thankDonorMediaHtml = '<div class="media single">\n        <img class="masonry-image" alt="' + escapeHtml(imageAlt) + '" src="' + escapeHtml(imageSrc) + '" />\n      </div>';
                }
                
                // Find Employee Spotlight section and wrap both in a side-by-side container
                // The Employee Spotlight is after the main-grid closes, so we need to find it and move it inside main-grid
                const employeeSpotlightPattern = /<!-- Employee Spotlight -->\s*<section class="callout bottom-spotlight"([^>]*)>([\s\S]*?)<\/section>/;
                if (employeeSpotlightPattern.test(output)) {
                    const match = output.match(employeeSpotlightPattern);
                    const employeeSpotlightContent = match[2];
                    
                    // Create Thank the Donor HTML without masonry-item class (it's inside a grid container now)
                    // Explicitly override any grid-column rules from template CSS
                    const thankDonorHtml = '\n<!-- Thank the Donor -->\n<section class="thank-donor-section" style="background: #f4b322; color: #fff; border-radius: var(--radius); padding: 22px 20px; box-shadow: 0 2px 10px rgba(12,42,74,.06); margin: 0; display: block; width: 100%; grid-column: 1; grid-row: 1;">\n  <h2 style="color: #fff; font-family: \'Roboto Condensed\', Helvetica, sans-serif; font-weight: 700; text-transform: uppercase; margin-bottom: 12px;">' + escapeHtml(thankTheDonor.title) + '</h2>\n  <p style="color: #fff;">' + thankDonorBody + '</p>\n  ' + thankDonorMediaHtml + '\n</section>\n';
                    
                    // Build side-by-side container HTML
                    // Use column-span: all to break out of masonry columns, then use CSS Grid for side-by-side layout
                    // Both sections should split the width 50/50
                    // Remove masonry-item from children since they're in a grid container
                    // Explicitly set grid-column on Employee Spotlight to place it in the second column
                    const sideBySideHtml = '\n<!-- Side-by-Side Container for Thank the Donor and Employee Spotlight -->\n<div class="side-by-side-container masonry-item" style="column-span: all; -webkit-column-span: all; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); margin-top: var(--gap); width: 100%; break-inside: avoid;">\n' + thankDonorHtml + '\n<!-- Employee Spotlight -->\n<section class="callout bottom-spotlight" style="margin: 0; display: block; width: 100%; grid-column: 2; grid-row: 1;">' + employeeSpotlightContent + '</section>\n</div>\n';
                    
                    // Remove Employee Spotlight from its current location (outside main-grid)
                    output = output.replace(employeeSpotlightPattern, '');
                    
                    // Insert side-by-side container INSIDE main-grid before it closes
                    // Find the closing </div> of main-grid (which is before Footer)
                    const mainGridClosePattern = /(<\/div>\s*)(<!-- Footer -->)/;
                    if (mainGridClosePattern.test(output)) {
                        const beforeFooter = output.substring(0, output.indexOf('<!-- Footer -->'));
                        const lastDivIndex = beforeFooter.lastIndexOf('</div>');
                        
                        if (lastDivIndex !== -1) {
                            // Insert side-by-side container before main-grid closes
                            const beforeMainGridClose = output.substring(0, lastDivIndex);
                            const afterMainGridClose = output.substring(lastDivIndex);
                            output = beforeMainGridClose + sideBySideHtml + afterMainGridClose;
                        } else {
                            // Fallback: insert before Footer
                            output = output.replace(mainGridClosePattern, sideBySideHtml + '$1$2');
                        }
                    } else {
                        // Fallback: try to find main-grid closing tag
                        const mainGridRegex = /(<div class="main-grid">[\s\S]*?)(<\/div>\s*)(<!-- Footer -->)/;
                        if (mainGridRegex.test(output)) {
                            output = output.replace(mainGridRegex, '$1' + sideBySideHtml + '$2$3');
                        }
                    }
                } else {
                    // If pattern not found, insert before the closing </div> before footer
                    const beforeFooterPattern = /<\/div>\s*<!-- Footer -->/;
                    if (beforeFooterPattern.test(output)) {
                        output = output.replace(beforeFooterPattern, thankDonorHtml + '</div>\n<!-- Footer -->');
                    }
                }
            } else {
                // When Thank the Donor is not present, move Employee Spotlight inside main-grid and ensure it spans full width
                const employeeSpotlightPattern = /<!-- Employee Spotlight -->\s*<section class="callout bottom-spotlight"([^>]*)>([\s\S]*?)<\/section>/;
                if (employeeSpotlightPattern.test(output)) {
                    const match = output.match(employeeSpotlightPattern);
                    const employeeSpotlightContent = match[2];
                    const employeeSpotlightAttrs = match[1] || '';
                    
                    // Remove Employee Spotlight from its current location (outside main-grid)
                    output = output.replace(employeeSpotlightPattern, '');
                    
                    // Create Employee Spotlight with full width styling
                    const fullWidthSpotlight = '\n<!-- Employee Spotlight -->\n<section class="callout bottom-spotlight masonry-item" style="column-span: all; -webkit-column-span: all; width: 100%; break-inside: avoid; margin-top: var(--gap);">' + employeeSpotlightContent + '</section>\n';
                    
                    // Find the main-grid closing tag specifically by tracking div depth
                    // This ensures we find the correct closing tag for main-grid, not the wrapper
                    const mainGridStartIndex = output.indexOf('<div class="main-grid">');
                    if (mainGridStartIndex !== -1) {
                        // Find the matching closing </div> for main-grid by tracking depth
                        let depth = 0;
                        let mainGridCloseIndex = -1;
                        
                        for (let i = mainGridStartIndex; i < output.length; i++) {
                            // Check for opening div tag (but not self-closing)
                            if (output.substring(i, i + 4) === '<div' && output.substring(i, i + 5) !== '<div/') {
                                // Make sure it's not a closing tag
                                if (i === 0 || output[i - 1] !== '/') {
                                    depth++;
                                }
                            } else if (output.substring(i, i + 6) === '</div>') {
                                depth--;
                                if (depth === 0) {
                                    // Found the closing tag for main-grid
                                    mainGridCloseIndex = i + 6;
                                    break;
                                }
                            }
                        }
                        
                        if (mainGridCloseIndex !== -1) {
                            // Insert Employee Spotlight before the closing </div> of main-grid
                            const beforeMainGridClose = output.substring(0, mainGridCloseIndex);
                            const afterMainGridClose = output.substring(mainGridCloseIndex);
                            output = beforeMainGridClose + fullWidthSpotlight + afterMainGridClose;
                        }
                    }
                }
            }

            // Store output in hidden element for copying
            let codeOutputEl = document.getElementById('codeOutput');
            if (!codeOutputEl) {
                // Create hidden element if it doesn't exist
                codeOutputEl = document.createElement('code');
                codeOutputEl.id = 'codeOutput';
                codeOutputEl.style.display = 'none';
                document.body.appendChild(codeOutputEl);
            }
            codeOutputEl.textContent = output;
            
            // Save current scroll position and focused element before updating preview
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const activeElement = document.activeElement;
            let cursorPosition = null;
            let inputValue = null;
            
            // Save cursor position if active element is a text input or textarea
            const isTextInput = activeElement && (
                (activeElement.tagName === 'INPUT' && (activeElement.type === 'text' || activeElement.type === '')) ||
                activeElement.tagName === 'TEXTAREA'
            );
            
            if (isTextInput) {
                cursorPosition = activeElement.selectionStart;
                inputValue = activeElement.value;
            }
            
            // Update preview
            const previewFrame = document.getElementById('previewFrame');
            if (previewFrame) {
                previewFrame.srcdoc = output;
            }
            
            // Restore scroll position and focus after a brief delay to allow iframe to update
            // Use requestAnimationFrame for better timing
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    // Restore scroll position first
                    window.scrollTo({
                        left: scrollLeft,
                        top: scrollTop,
                        behavior: 'auto'
                    });
                    
                    if (isTextInput && activeElement && document.body.contains(activeElement)) {
                        // Restore focus if the input still exists, but prevent scroll
                        try {
                            // Focus without scrolling
                            activeElement.focus({ preventScroll: true });
                            
                            // Restore cursor position if we saved it
                            if (cursorPosition !== null && activeElement.setSelectionRange) {
                                // Use the current value length as a fallback if cursor position is out of bounds
                                const maxPos = activeElement.value.length;
                                const pos = Math.min(cursorPosition, maxPos);
                                activeElement.setSelectionRange(pos, pos);
                            }
                            
                            // Ensure scroll position is still correct after focus
                            requestAnimationFrame(function() {
                                window.scrollTo({
                                    left: scrollLeft,
                                    top: scrollTop,
                                    behavior: 'auto'
                                });
                            });
                        } catch (e) {
                            // Ignore focus errors (element might have been removed)
                            // Still restore scroll position
                            window.scrollTo({
                                left: scrollLeft,
                                top: scrollTop,
                                behavior: 'auto'
                            });
                        }
                    } else {
                        // If no active element or it's not a text input, just restore scroll position
                        window.scrollTo({
                            left: scrollLeft,
                            top: scrollTop,
                            behavior: 'auto'
                        });
                    }
                });
            });
        }

        // Debounced real-time update function
        function updateOutputRealTime() {
            // Clear any pending update
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Debounce: wait 300ms after last change before updating
            updateTimeout = setTimeout(function() {
                generateOutputCore(false); // false = don't scroll
            }, 300);
        }

        function copyToClipboard() {
            // Generate output if not already generated
            generateOutputCore(false);
            
            const codeOutput = document.getElementById('codeOutput');
            if (!codeOutput || !codeOutput.textContent) {
                alert('No code to copy yet. Please fill in some article information first.');
                return;
            }
            
            const text = codeOutput.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function showImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.style.display = 'block';
                const textarea = document.getElementById('importHtmlTextarea');
                if (textarea) {
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function importHtml() {
            const textarea = document.getElementById('importHtmlTextarea');
            if (!textarea || !textarea.value.trim()) {
                alert('Please paste HTML content to import.');
                return;
            }

            const htmlContent = textarea.value.trim();
            
            try {
                // Create a temporary DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                // Extract publication date
                const dateBadge = doc.querySelector('.date-badge');
                if (dateBadge) {
                    const dateText = dateBadge.textContent.trim();
                    // Try to parse the date - it might be in "Month Day, Year" format
                    // We'll need to convert it back to YYYY-MM-DD
                    const dateInput = document.getElementById('publicationDate');
                    if (dateInput) {
                        // Try to find date in schema or parse from date badge
                        const schemaScripts = doc.querySelectorAll('script[type="application/ld+json"]');
                        let foundDate = null;
                        schemaScripts.forEach(script => {
                            try {
                                const schema = JSON.parse(script.textContent);
                                if (schema.datePublished) {
                                    foundDate = schema.datePublished;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        });
                        
                        if (foundDate) {
                            dateInput.value = foundDate;
                            updatePublicationDate(foundDate);
                        } else {
                            // Try to parse from date badge text (e.g., "November 10, 2025")
                            const dateMatch = dateText.match(/(\w+)\s+(\d+),\s+(\d+)/);
                            if (dateMatch) {
                                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                                  'July', 'August', 'September', 'October', 'November', 'December'];
                                const month = monthNames.indexOf(dateMatch[1]);
                                const day = parseInt(dateMatch[2]);
                                const year = parseInt(dateMatch[3]);
                                if (month !== -1) {
                                    const dateString = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                                    dateInput.value = dateString;
                                    updatePublicationDate(dateString);
                                }
                            }
                        }
                    }
                }
                
                // Extract articles
                const articleElements = doc.querySelectorAll('article.card.masonry-item');
                const importedArticles = [];
                
                articleElements.forEach((articleEl, index) => {
                    const titleEl = articleEl.querySelector('h2');
                    const imgEl = articleEl.querySelector('img.masonry-image');
                    const videoEl = articleEl.querySelector('iframe');
                    const mediaEl = articleEl.querySelector('.media');
                    
                    // Get all body content - get all p tags and combine their content
                    let bodyContent = '';
                    const allParagraphs = articleEl.querySelectorAll('p');
                    
                    if (allParagraphs.length > 0) {
                        // Get all p tags that are direct children of the article (siblings)
                        const siblingParagraphs = Array.from(articleEl.children).filter(child => child.tagName === 'P');
                        
                        if (siblingParagraphs.length > 1) {
                            // Multiple sibling p tags - combine their outerHTML to preserve paragraph structure
                            bodyContent = siblingParagraphs.map(p => p.outerHTML).join('');
                        } else if (siblingParagraphs.length === 1) {
                            // Single p tag (might have nested paragraphs inside) - get its innerHTML
                            // This will include all nested content like multiple <p> tags inside
                            bodyContent = siblingParagraphs[0].innerHTML;
                        } else {
                            // No direct child p tags, but there are p tags somewhere - get the first one's innerHTML
                            // This handles nested structures
                            bodyContent = allParagraphs[0].innerHTML;
                        }
                    }
                    
                    const article = {
                        title: titleEl ? titleEl.textContent.trim() : '',
                        body: bodyContent.trim(),
                        imageUrl: imgEl ? imgEl.getAttribute('src') || '' : '',
                        imageAlt: imgEl ? imgEl.getAttribute('alt') || '' : '',
                        videoUrl: '',
                        galleryUrls: []
                    };
                    
                    // Extract video URL if present
                    if (videoEl) {
                        const videoSrc = videoEl.getAttribute('src') || '';
                        // Convert embed URL back to regular URL if needed
                        article.videoUrl = convertFromEmbedUrl(videoSrc);
                    }
                    
                    // Extract gallery images from scripts
                    const imgId = imgEl ? imgEl.getAttribute('id') : '';
                    
                    if (imgId) {
                        // Look for gallery scripts that reference this image ID
                        const scripts = doc.querySelectorAll('script');
                        scripts.forEach(script => {
                            const scriptText = script.textContent || '';
                            
                            // Check if this script references our image ID
                            if (scriptText.includes('getElementById("' + imgId + '")')) {
                                // This is a gallery script for this image
                                // Extract the image array - look for formImages_ variable (can be multiline)
                                // Pattern: const formImages_xxx = [ ... ]
                                const arrayMatch = scriptText.match(/const\s+formImages_\w+\s*=\s*\[([\s\S]*?)\]/);
                                if (arrayMatch) {
                                    const urlsString = arrayMatch[1];
                                    // Extract URLs from the array - handle multiline and quoted strings
                                    const urlMatches = urlsString.match(/"([^"]+)"/g);
                                    if (urlMatches) {
                                        article.galleryUrls = urlMatches.map(match => {
                                            return match.replace(/^"/, '').replace(/"$/, '').trim();
                                        }).filter(url => url);
                                    }
                                }
                            }
                        });
                    }
                    
                    // If we found gallery images, clear imageUrl since gallery takes priority
                    if (article.galleryUrls.length > 0) {
                        article.imageUrl = '';
                        article.imageAlt = '';
                    }
                    
                    importedArticles.push(article);
                });
                
                // Extract Employee Spotlight
                const spotlightSection = doc.querySelector('section.callout.bottom-spotlight');
                if (spotlightSection) {
                    const nameEl = spotlightSection.querySelector('h2');
                    const titleEl = spotlightSection.querySelector('p');
                    const imgEl = spotlightSection.querySelector('img.spotlight-photo');
                    const contentEl = spotlightSection.querySelector('.spotlight-grid > div:last-child p');
                    
                    if (nameEl) {
                        employeeSpotlight.name = nameEl.textContent.trim();
                        document.getElementById('employeeSpotlightName').value = employeeSpotlight.name;
                    }
                    
                    if (titleEl) {
                        employeeSpotlight.title = titleEl.textContent.trim();
                        document.getElementById('employeeSpotlightTitle').value = employeeSpotlight.title;
                    }
                    
                    if (imgEl) {
                        employeeSpotlight.imageUrl = imgEl.getAttribute('src') || '';
                        document.getElementById('employeeSpotlightImageUrl').value = employeeSpotlight.imageUrl;
                    }
                    
                    // Extract questions and answers from content
                    if (contentEl) {
                        const contentHtml = contentEl.innerHTML;
                        // Parse Q&A pairs - they're in format <strong>Question</strong><br>Answer<br><br>
                        const qaPairs = [];
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = contentHtml;
                        
                        let currentQuestion = '';
                        let currentAnswer = '';
                        const nodes = Array.from(tempDiv.childNodes);
                        
                        nodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                if (node.tagName === 'STRONG') {
                                    if (currentQuestion && currentAnswer) {
                                        qaPairs.push({question: currentQuestion.trim(), answer: currentAnswer.trim()});
                                    }
                                    currentQuestion = node.textContent.trim();
                                    currentAnswer = '';
                                } else if (node.tagName === 'BR') {
                                    // Skip BR tags
                                } else {
                                    currentAnswer += (currentAnswer ? ' ' : '') + node.textContent.trim();
                                }
                            } else if (node.nodeType === 3) { // Text node
                                if (currentQuestion) {
                                    currentAnswer += (currentAnswer ? ' ' : '') + node.textContent.trim();
                                }
                            }
                        });
                        
                        if (currentQuestion && currentAnswer) {
                            qaPairs.push({question: currentQuestion.trim(), answer: currentAnswer.trim()});
                        }
                        
                        if (qaPairs.length > 0) {
                            employeeSpotlight.questions = qaPairs;
                            renderEmployeeSpotlightQuestions();
                        }
                    }
                }
                
                // Extract Thank the Donor section
                const thankDonorSection = doc.querySelector('section.thank-donor-section');
                if (thankDonorSection) {
                    const titleEl = thankDonorSection.querySelector('h2');
                    const bodyEl = thankDonorSection.querySelector('p');
                    const imgEl = thankDonorSection.querySelector('img');
                    
                    if (titleEl) {
                        thankTheDonor.title = titleEl.textContent.trim();
                    }
                    
                    if (bodyEl) {
                        thankTheDonor.body = bodyEl.innerHTML.trim();
                    }
                    
                    if (imgEl) {
                        thankTheDonor.imageUrl = imgEl.getAttribute('src') || '';
                        thankTheDonor.imageAlt = imgEl.getAttribute('alt') || '';
                    }
                    
                    thankTheDonor.enabled = true;
                    // Hide the add button
                    const addBtn = document.getElementById('addThankDonorBtn');
                    if (addBtn) {
                        addBtn.style.display = 'none';
                    }
                    renderThankDonor();
                } else {
                    // If no Thank the Donor section, disable it
                    thankTheDonor.enabled = false;
                    const addBtn = document.getElementById('addThankDonorBtn');
                    if (addBtn) {
                        addBtn.style.display = 'inline-block';
                    }
                }
                
                // Replace existing articles with imported ones
                if (importedArticles.length > 0) {
                    // Clear existing articles
                    articles = [];
                    articleCounter = 0;
                    
                    // Clear Quill editors
                    Object.keys(quillEditors).forEach(key => {
                        if (quillEditors[key]) {
                            quillEditors[key] = null;
                            delete quillEditors[key];
                        }
                    });
                    
                    // Add imported articles
                    importedArticles.forEach(importedArticle => {
                        const article = {
                            id: 'article-' + (++articleCounter),
                            title: importedArticle.title || '',
                            body: importedArticle.body || '',
                            imageUrl: importedArticle.imageUrl || '',
                            imageAlt: importedArticle.imageAlt || '',
                            videoUrl: importedArticle.videoUrl || '',
                            galleryUrls: importedArticle.galleryUrls || [],
                            collapsed: false
                        };
                        articles.push(article);
                    });
                    
                    // Re-render everything
                    renderArticles();
                    setupDragDrop();
                }
                
                // Close modal
                closeImportModal();
                
                // Show success message
                alert('HTML imported successfully! ' + importedArticles.length + ' article(s) imported.');
                
                // Update output
                updateOutputRealTime();
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing HTML: ' + error.message);
            }
        }

        // Helper function to convert embed URL back to regular URL
        function convertFromEmbedUrl(embedUrl) {
            if (!embedUrl) return '';
            
            // YouTube embed format: https://www.youtube.com/embed/VIDEO_ID
            const youtubeMatch = embedUrl.match(/youtube\.com\/embed\/([^?]+)/);
            if (youtubeMatch) {
                return 'https://www.youtube.com/watch?v=' + youtubeMatch[1];
            }
            
            // Vimeo embed format: https://player.vimeo.com/video/VIDEO_ID
            const vimeoMatch = embedUrl.match(/vimeo\.com\/video\/([^?]+)/);
            if (vimeoMatch) {
                return 'https://vimeo.com/' + vimeoMatch[1];
            }
            
            return embedUrl;
        }

        function setupDragDrop() {
            const articleGroups = document.querySelectorAll('.article-group');
            
            articleGroups.forEach(group => {
                group.addEventListener('dragstart', handleDragStart);
                group.addEventListener('dragover', handleDragOver);
                group.addEventListener('drop', handleDrop);
                group.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(this.parentNode, e.clientY);
            const dragging = document.querySelector('.dragging');
            
            if (afterElement == null) {
                this.parentNode.appendChild(dragging);
            } else {
                this.parentNode.insertBefore(dragging, afterElement);
            }
            
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const allGroups = Array.from(this.parentNode.querySelectorAll('.article-group'));
                const draggedIndex = allGroups.indexOf(draggedElement);
                const targetIndex = allGroups.indexOf(this);

                // Reorder articles array
                const draggedArticle = articles[draggedIndex];
                articles.splice(draggedIndex, 1);
                articles.splice(targetIndex, 0, draggedArticle);

                renderArticles();
                setupDragDrop();
                updateOutputRealTime(); // Real-time update after reorder
            }

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            document.querySelectorAll('.article-group').forEach(group => {
                group.classList.remove('dragging');
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.article-group:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>
</body>
</html>

